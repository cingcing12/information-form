<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <style>
      .container.containerEdit {
        max-width: 600px;
        width: 100%;
        border: 1px solid white;
        padding: 40px;
        border-radius: 20px;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) translateY(-50px);
        transition: 0.5s ease;
        opacity: 0;
        visibility: hidden;
        z-index: 100;
      }

      .container.containerEdit.active {
        transform: translate(-50%, -50%) translateY(0px);
        opacity: 1;
        visibility: visible;
      }

      .overlay {
        position: fixed;
        width: 100%;
        height: 100%;
        z-index: 99;
        inset: 0;
        background-color: black;
        opacity: 0;
        visibility: hidden;
        transition: 0.5s ease;
      }

      .overlay.active {
        opacity: 0.75;
        visibility: visible;
      }

      table.hidden{
        display: none;
      }

      .containerAdmin{
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-50px);
        text-align: center;
        background-color: black;
        border-radius: 5px;
        padding: 20px;
        text-wrap: nowrap;
        font-weight: bold;
        opacity: 0;
        visibility: hidden;
        animation: adminAnima 0.50s linear forwards;
      }

      @keyframes adminAnima{
        to{
          transform: translateX(-50%) translateY(0px);
          opacity: 1;
          visibility: visible;
        }
      }

      .containerAdmin.hidden{
        background-color: red;
        animation: hiddenAmin 0.50s linear forwards;
      }

      @keyframes hiddenAmin{
        to{
          transform: translateX(-50%) translateY(-50px);
          opacity: 0;
          visibility: hidden;
        }
      }

    </style>
  </head>
  <body data-bs-theme="dark">

    <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      <a href="index.html" class="nav-brand nav-link fs-2"><i class="bi bi-person-lines-fill"></i></a>
      <button class="navbar-toggler" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBothOptions"><span class="navbar-toggler-icon"></span></button>

      <div class="offcanvas offcanvas-start" id="offcanvasWithBothOptions">
        <div class="offcanvas-header">
          <a href="index.html" class="nav-brand nav-link fs-2 offcanvas-title"><i class="bi bi-person-lines-fill"></i></a>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <ul class="justify-content-end flex-grow-1 navbar-nav gap-2">
            <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
            <li class="nav-item"><a href="views.html" class="nav-link">Admin</a></li>
            <li class="nav-item"><button class="btn btn-outline-danger logout d-flex align-items-center gap-1"><i class="bi bi-box-arrow-right"></i> Logout</button></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="containerAdmin"></div>

    <div class="containerTable table-responsive my-4">
      <div class="container">
        <h2 class="fs-2 mb-4">Information Table</h2>
        <table class="table table-hover">
          <thead>
            <tr>
              <th>First name</th>
              <th>Last name</th>
              <th>Age</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="overlay"></div>

    <div class="container containerEdit">
      <form>
        <h2 class="h2 mb-4">‚úè Information Form Edit</h2>
        <div class="row">
          <div class="col-lg-6 col-12 mb-4">
            <input
              type="text"
              name="first_name"
              required
              placeholder="first_name"
              class="form-control"
              id="first_name"
            />
          </div>
          <div class="col-lg-6 col-12 mb-4">
            <input
              type="text"
              name="last_name"
              required
              placeholder="last_name"
              class="form-control"
              id="last_name"
            />
          </div>

          <div class="col-lg-6 col-12 mb-4">
            <input
              type="number"
              name="age"
              required
              placeholder="age"
              class="form-control"
              id="age"
            />
          </div>

          <div class="col-12 justify-content-end d-flex">
            <button type="submit" class="btn btn-primary">Confirm</button>
          </div>
        </div>
      </form>
    </div>

    <script>
      window.addEventListener("load", async () => {
        const checkLogin = JSON.parse(localStorage.getItem("checkLogin")) || [];
        const table = document.querySelector('table');
        table.classList.toggle('hidden', !checkLogin.login);
        if(!checkLogin.login){
          window.location.href = "https://cingcing12.github.io/information-form/login.html";
        }
        try {
          const res = await fetch("https://information-form-2.onrender.com");
          const data = await res.json();
          let dataId = null;
          const containerEdit = document.querySelector(
              ".container.containerEdit"
            );
            const overlay = document.querySelector(".overlay");

            const containerAdmin = document.querySelector('.containerAdmin')
            containerAdmin.innerHTML = `Welcome admin: ${checkLogin.emailAdmin}`;

            setTimeout(() => {
              containerAdmin.classList.add('hidden')
            }, 2000)

          data.forEach((item) => {
            const tr = document.createElement("tr");
            tr.dataset.id = item._id;
            tr.classList.add("containerItem");

            const fname = document.createElement("td");
            fname.classList.add("Fname");
            fname.textContent = item.first_name;
            tr.appendChild(fname);

            const lname = document.createElement("td");
            lname.classList.add("lname");
            lname.textContent = item.last_name;
            tr.appendChild(lname);

            const age = document.createElement("td");
            age.classList.add("age");
            age.textContent = item.age;
            tr.appendChild(age);

            const containerAction = document.createElement("td");
            containerAction.classList.add("containerAction");
            containerAction.innerHTML = `
                    <button class="btn btn-outline-primary edit"><i class="bi bi-pencil-square"></i> Edit</button>
                    <button class="btn btn-outline-danger remove"><i class="bi bi-trash-fill"></i> Delete</button>
                    `;
            tr.appendChild(containerAction);

            document.querySelector("tbody").appendChild(tr);

            const id = tr.dataset.id;

            tr.querySelector(".remove").addEventListener("click", () => {
              Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, delete it!",
              }).then(async (result) => {
                if (result.isConfirmed) {
                  try {
                    const res = await fetch(
                      `https://information-form-2.onrender.com/delete/${id}`,
                      {
                        method: "delete",
                        headers: { "Content-type": "application/json" },
                      }
                    );
                    const message = await res.json();
                    if (res.ok) {
                      Swal.fire({
                        title: "Deleted!",
                        text: message,     
                        icon: "success",
                      }).then(() => tr.remove());
                    } else {
                      Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: message,
                      });
                    }
                  } catch (err) {
                    Swal.fire({
                      icon: "error",
                      title: "Oops...",
                      text: err.message,
                    });
                  }
                }
              });
            });

            

            tr.querySelector(".edit").addEventListener("click", () => {
              containerEdit.classList.add("active");
              overlay.classList.add("active");

              let fnameEdit = document.querySelector("#first_name");
              let lnameEdit = document.querySelector("#last_name");
              let editAge = document.querySelector("#age");

              fnameEdit.value = fname.textContent;
              lnameEdit.value = lname.textContent;
              editAge.value = age.textContent;
              dataId = id;
              overlay.addEventListener("click", () => {
                containerEdit.classList.remove("active");
                overlay.classList.remove("active");

                document.querySelector("form").reset();
              });

              
            });
          });

           document
                .querySelector("form")
                .addEventListener("submit", async (e) => {
                  e.preventDefault();

                  const first_name = document.querySelector("#first_name").value;
                  const last_name = document.querySelector("#last_name").value;
                  const ageEdite = document.querySelector("#age").value;

                  try {
                    const res = await fetch(
                      `https://information-form-2.onrender.com/update/${dataId}`,
                      {
                        method: "PUT",
                        headers: { "Content-type": "application/json" },
                        body: JSON.stringify({
                          first_name,
                          last_name,
                          ageEdite,
                        }),
                      }
                    );

                    const message = await res.json();

                    if (res.ok) {
                      Swal.fire({
                        title: "Update!",
                        text: message.message,
                        icon: "success",
                      }).then(() => {
                        containerEdit.classList.remove("active");
                        overlay.classList.remove("active");
                        document.querySelector("form").reset();
                        const tr = document.querySelector(`tr[data-id="${dataId}"]`);
                        tr.querySelector(".Fname").textContent = first_name;
                        tr.querySelector('.lname').textContent = last_name;
                        tr.querySelector('.age').textContent = ageEdite;

                      });
                    } else {
                      Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: message,
                      });
                    }
                  } catch (err) {
                    Swal.fire({
                      icon: "error",
                      title: "Oops...",
                      text: err.message,
                    });
                  }
                });
        } catch (err) {
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: err.message,
          });
        }

        document.querySelector(".logout").addEventListener('click', async () => {
          try{
            Swal.fire({
                title: "Are you sure?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, logout please!",
              }).then(async (result) => {
                if (result.isConfirmed) {
                  fetch("https://information-form-2.onrender.com/logout", {
                    method: "POST",
                    headers: {"Content-type": "application/json"}
                  })
                  .then(async res => {
                    const message = await res.json();
                    if(res.ok){
                      Swal.fire({
                        title: "Successfully!",
                        text: message,
                        icon: "success",
                      })
                      .then(() => {
                        localStorage.removeItem("checkLogin");
                        window.location.href = "https://cingcing12.github.io/information-form/index.html";
                      })
                    }
                  })
                }
              });
          }catch(err){
            Swal.fire({
            icon: "error",
            title: "Oops...",
            text: err.message,
          });
          }
        })
        
      });

     
    </script>
  </body>
</html>
